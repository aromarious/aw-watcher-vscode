# aw-watcher-vscode コーディングガイドライン

このドキュメントは、aw-watcher-vscode プロジェクトにおけるコーディング規約、ワークフロー、ベストプラクティスを定義します。

## 目次

- [目次](#目次)
- [プロジェクト概要](#プロジェクト概要)
- [GitHub Project 連携](#github-project-連携)
- [グローバルポリシー](#グローバルポリシー)
  - [日本語コメント必須](#日本語コメント必須)
  - [ルートディレクトリ管理](#ルートディレクトリ管理)
  - [パッケージマネージャ](#パッケージマネージャ)
- [TypeScript/VSCode Extension 規約](#typescriptvscode-extension-規約)
  - [型安全性](#型安全性)
  - [コンソール出力](#コンソール出力)
  - [VSCode API の使用](#vscode-api-の使用)
  - [イベントハンドリング](#イベントハンドリング)
  - [設定項目](#設定項目)
- [テスト標準](#テスト標準)
  - [テスト戦略](#テスト戦略)
  - [設計パターン](#設計パターン)
  - [カバレッジ目標](#カバレッジ目標)
  - [境界値分析](#境界値分析)
  - [同値分割](#同値分割)
  - [独立性の確保](#独立性の確保)
  - [モックの適切な使用](#モックの適切な使用)
  - [命名規則](#命名規則)
  - [テスト実施](#テスト実施)
- [Git \& PR ワークフロー](#git--pr-ワークフロー)
  - [フォークプロジェクトとして](#フォークプロジェクトとして)
  - [ブランチ戦略](#ブランチ戦略)
  - [開発フロー](#開発フロー)
  - [コミット](#コミット)
  - [本家へのコントリビューション](#本家へのコントリビューション)
- [リリースワークフロー](#リリースワークフロー)
  - [CI/CD](#cicd)
  - [リリース手順](#リリース手順)
  - [自動リリース](#自動リリース)
  - [バージョニング](#バージョニング)
- [Markdown スタイルガイド](#markdown-スタイルガイド)

## プロジェクト概要

**aw-watcher-vscode** は [ActivityWatch](https://github.com/ActivityWatch/activitywatch) の VSCode 拡張機能です。このプロジェクトは本家リポジトリからフォークし、記録漏れの改善などを行うものです。

- **技術スタック**:
  - TypeScript 5.9.3
  - VSCode Extension API
  - Node.js v23.10.0+（fetch API サポート）
  - @types/node 25.2.2
- **テストフレームワーク**: Mocha
- **パッケージマネージャ**: pnpm
- **本家リポジトリ**: https://github.com/ActivityWatch/aw-watcher-vscode
- **aw-client-js**: Git サブモジュールとして管理（commit b2e02b3 以降、fetch API 使用）

## GitHub Project 連携

このプロジェクトはaw-daily-reporterの改善の一環として開発されており、下記のGitHub Projectで管理されています。

https://github.com/users/aromarious/projects/6

新しいメジャータスクや機能開発を開始する前に、GitHubプロジェクトを確認し、現在のプロジェクト優先度と計画されたタスクを理解すること。ユーザーのリクエストがGitHubプロジェクト内の項目と一致する場合は、それを言及し、作業の進捗に応じてGitHubプロジェクトのステータスを更新すること。

## グローバルポリシー

### 日本語コメント必須

すべてのコードコメントおよびドキュメントは日本語で記述すること。

### ルートディレクトリ管理

プロジェクトルート直下にファイルを配置することは極力避けること。新しくファイルを配置する必要がある場合は、必ずユーザーに許可を得ること。

### パッケージマネージャ

pnpm のみを使用すること（package.json で `packageManager` フィールドにより強制）。

## TypeScript/VSCode Extension 規約

### 型安全性

- **implicit any 禁止**: すべての変数および関数パラメータに明示的な型を付ける。絶対に必要でない限り `any` を避ける。
- **VSCode API の型**: VSCode Extension API の型を正しく使用する（`vscode` モジュールから適切な型をインポート）。
- **戻り値の型**: すべての関数に戻り値の型を定義する。

### コンソール出力

- **console.log 使用可**: VSCode拡張機能では、ユーザーへの通知は出力チャネルまたはステータスバーを使用するが、開発中のデバッグには `console.log` を使用してもよい（ただし、本番コードではクリーンアップを推奨）。
- **エラーハンドリング**: `console.error` で実行時エラーをログに記録する。

### VSCode API の使用

- **Disposables の管理**: すべてのイベントリスナーやリソースは適切に `Disposable` として登録し、`subscriptions` 配列に追加する。
- **Extension Context**: 拡張機能のライフサイクルを適切に管理する。`activate()` と `deactivate()` を正しく実装する。
- **非同期処理**: VSCode API の非同期メソッドは `async/await` を使用して処理する。

### イベントハンドリング

- **レート制限**: 高頻度で発火するイベント（テキスト変更など）には適切なレート制限を実装する。
- **エラーハンドリング**: イベントハンドラー内で発生したエラーは適切にキャッチし、ログに記録する。拡張機能全体をクラッシュさせない。
- **パフォーマンス**: イベントハンドラーは軽量に保ち、重い処理は非同期で実行する。

### 設定項目

- **設定の取得**: `vscode.workspace.getConfiguration()` を使用して設定を取得する。
- **デフォルト値**: すべての設定項目にデフォルト値を定義する（`package.json` の `contributes.configuration` セクション）。
- **型安全性**: 設定値を取得する際は適切な型を指定する。

## テスト標準

### テスト戦略

- **ユニットテスト**: Mocha を使用
- **VSCode Extension Testing**: VSCode の拡張機能テストフレームワークを使用

### 設計パターン

- **AAA パターン**: テストコード内を **Arrange（準備）**、**Act（実行）**、**Assert（検証）** のブロックに明確に分け、コメントで構造を示すこと。

### カバレッジ目標

- **C1（分岐網羅）100%** を目指すこと。

### 境界値分析

判定ロジックに対しては「**On / Off / In**」の3点、あるいは最低限「**On / Off**」の2点を網羅すること。

### 同値分割

正常系（有効同値）だけでなく、異常系（無効同値）の代表値を必ず含めること。

### 独立性の確保

各テストケースは他のテストに依存せず、実行順序を問わず成功するように実装すること。

### モックの適切な使用

外部 API（ActivityWatch サーバー）、VSCode API へのアクセスは適切にモック化し、テストの実行速度と再現性を担保すること。

### 命名規則

`test_[対象関数]_[シナリオ]_[期待される結果]` または `describe/it` スタイルの形式で命名し、テストコード自体を仕様書として読めるようにすること。

### テスト実施手順

#### 前提条件

- ActivityWatch サーバーが起動していること（ポート5600で動作）
- Node.js v23.10.0 以上がインストールされていること
- pnpm がインストールされていること

#### テストの実行方法

```bash
# すべてのテストを実行
pnpm test

# または
pnpm run test:mocha
```

#### テスト対象

現在のテストスイート（`src/test/extension.test.ts`）は以下をカバー：

- **Bucket Operations**: バケットの作成、取得、削除
- **Event Operations**: イベントの挿入、取得
- **Heartbeat Operations**: ハートビートの送信、マージ、連続送信
- **Client Information**: サーバー情報の取得

#### 開発時のデバッグ

VSCode のデバッグ機能を使用してテストをデバッグする場合：

1. `.vscode/launch.json` にデバッグ設定を追加
2. ブレークポイントを設定
3. F5 キーでデバッグ実行

#### トラブルシューティング

- **"fetch failed" エラー**: ActivityWatch サーバーが起動していることを確認
  ```bash
  curl http://127.0.0.1:5600/api/0/info
  ```
- **コンパイルエラー**: `pnpm run compile` で事前にコンパイルして確認
- **テストタイムアウト**: サーバーの応答が遅い場合は `this.timeout(5000)` の値を増やす

### テスト実施

#### テスト実行コマンド

このプロジェクトには以下のテスト実行方法が用意されています。

**1. 標準テスト（推奨）**

```bash
pnpm test
```

または

```bash
pnpm run test:mocha
```

- TypeScriptをコンパイル後、Mochaを直接実行
- コマンドラインで完結し、GUIが不要
- CI/CD環境でも実行可能

**2. VSCode拡張機能テストランナーを使用**

```bash
pnpm run test:vscode
```

- TypeScriptをコンパイル後、VSCodeのテストランナーを起動
- 実際のVSCode環境でテストを実行
- **注意**: GUI ウィンドウが開くため、ヘッドレス環境では使用できない場合がある

#### テストファイルの場所

- `src/test/extension.test.ts` - メインのテストファイル
- `src/test/index.ts` - テストランナーの設定ファイル
- `aw-client-js/src/test/test.ts` - ActivityWatch クライアントライブラリのテスト

#### 開発時のワークフロー

1. **ウォッチモード**: コード変更時に自動コンパイル

   ```bash
   pnpm run watch
   ```

2. **コンパイルのみ**: テスト実行前に手動でコンパイル

   ```bash
   pnpm run compile
   ```

3. **テスト実行**: 上記のテストコマンドを実行

4. **Lintチェック**: テスト前後でコード品質を確認

   ```bash
   pnpm run check
   ```

#### VSCode内でのテスト実行

VSCodeのデバッグ機能を使用してテストを実行することも可能です。

1. F5キーを押す、または
2. デバッグパネルから「Extension Tests」を選択して実行

この方法では、ブレークポイントを設定してステップ実行によるデバッグが可能です。

## Git & PR ワークフロー

### フォークプロジェクトとして

このプロジェクトは ActivityWatch/aw-watcher-vscode からフォークしたものです。

- **改善内容の記録**: 本家との差分を `docs/` ディレクトリに記録する。
- **本家への配慮**: 将来的に本家にマージされることを意識して、コードの品質を保つ。
- **.vsix 配布**: マーケットプレイスには公開せず、GitHub Releases で .vsix ファイルを配布する。

### ブランチ戦略

このプロジェクトは **2ブランチ体制** を採用します。

- **master**: 本家追跡用（`upstream/master` と同期、本家へのPRの起点）
- **main**: フォークの統合ブランチ（フォーク独自の開発、常にデプロイ可能な状態を維持）
- **feature/\***: 新機能開発用（`main` への PR 元）
- **fix/\***: バグ修正用（`main` への PR 元）
- **upstream-pr/\***: 本家へのPR用（`master` から分岐、`upstream/master` への PR 元）

#### ブランチの役割

```
master (本家追跡)     main (フォークの本筋)
    ↓                      ↑
upstream/master      feature/*, fix/*
```

#### 本家への同期

定期的に本家の変更を取り込む：

```bash
git checkout master
git pull upstream master
git push origin master
```

### 開発フロー

#### フォーク独自の開発

1. **作業ブランチの作成**: `main` から `feature/*` または `fix/*` ブランチを作成して開発する。
2. **プルリクエスト（PR）**: ユーザーがプルリクの作成を指示したら `main` に向けて作成する。
3. **マージ後の処理**: ユーザーが「プルリクマージしました」と言ったら、作業ブランチのローカル・リモート ref を削除する。

#### 本家へのPR

1. **master の同期**: `master` を `upstream/master` と同期する。
2. **PR用ブランチの作成**: `master` から `upstream-pr/*` ブランチを作成する。
3. **変更の適用**: `main` からの変更をチェリーピックまたはマージする。
4. **PRの作成**: `upstream/master` に向けてPRを作成する。

### コミット

- **作成タイミング**: コミットを作成してくださいと言うまで、コミットの作成も実行もしない。
- **メッセージ形式**: Conventional Commits (`feat`, `fix`, `docs` など) を使用する。
- **wip コミット**: `feature/*` ブランチでは許可されるが、マージ前にスカッシュする必要がある。

### 本家へのコントリビューション

- **本家への PR**: 改善内容が安定したら、`master` から `upstream-pr/*` ブランチを作成し、本家リポジトリへの PR を検討する。
- **変更の分離**: フォーク固有の変更と、本家にも有益な変更を分離してPRを作成する。
- **コミュニティとの連携**: ActivityWatch コミュニティと連携し、改善内容を共有する。
- **Issue の確認**: 本家の Issue や PR を定期的に確認し、重複を避ける。
- **本家の状況**: 本家は現在メンテナンスが滞っているため、PRがすぐにマージされない可能性がある（詳細は [repository-status.md](docs/repository-status.md) 参照）。

## リリースワークフロー

このプロジェクトでは、Gitタグをpushすることで自動的にGitHub Releasesが作成され、VSIXファイルが配布される仕組みを採用しています。

### CI/CD

GitHub Actionsを使用して、コード品質とテストを自動的にチェックしています。

#### CI（継続的インテグレーション）

`.github/workflows/ci.yml`により、以下が自動実行されます：

- **トリガー**: すべてのブランチへのpush、およびすべてのプルリクエスト
- **実行内容**:
  1. リポジトリのチェックアウト（サブモジュール含む）
  2. Node.js 23とpnpm 9のセットアップ
  3. 依存関係のインストール
  4. **Lint**: `pnpm run check` - Biomeによるコード品質チェック
  5. **Type check**: `pnpm run compile` - TypeScriptのコンパイルと型チェック
  6. **Test**: `pnpm test` - Mochaによるユニットテストの実行

#### ローカルでの実行

プッシュ前にローカルで同じチェックを実行できます：

```bash
# すべてのチェックを順番に実行
pnpm run check      # Lint
pnpm run compile    # Type check
pnpm test          # Test

# または、まとめて実行
pnpm run check && pnpm run compile && pnpm test
```

### リリース手順

1. **バージョン更新**
   ```bash
   # package.jsonのバージョンを更新（例: 0.5.0 → 0.5.1）
   # 手動で編集するか、npmコマンドを使用
   pnpm version patch  # パッチバージョンアップ (0.5.0 → 0.5.1)
   pnpm version minor  # マイナーバージョンアップ (0.5.0 → 0.6.0)
   pnpm version major  # メジャーバージョンアップ (0.5.0 → 1.0.0)
   ```

2. **変更のコミット**
   ```bash
   git add package.json pnpm-lock.yaml
   git commit -m "chore: bump version to v0.5.1"
   ```

3. **タグの作成とpush**
   ```bash
   # タグを作成（vプレフィックス必須）
   git tag v0.5.1

   # タグをリモートにpush
   git push origin v0.5.1
   ```

4. **自動リリース**
   - GitHub Actionsが自動的にトリガーされる
   - テストが実行される
   - VSIXファイルがビルドされる
   - GitHub Releaseが作成され、VSIXファイルが添付される

### 自動リリース

`.github/workflows/release.yml`により、以下の処理が自動実行されます：

- **トリガー**: `v*.*.*`形式のタグがpushされたとき
- **実行内容**:
  1. リポジトリのチェックアウト（サブモジュール含む）
  2. Node.js 23とpnpm 9のセットアップ
  3. 依存関係のインストール
  4. テストの実行
  5. VSIXファイルのビルド
  6. GitHub Releaseの作成とVSIXファイルのアップロード

### バージョニング

セマンティックバージョニング（SemVer）に従う：

- **Major (x.0.0)**: 破壊的変更
  - 例: API変更、設定項目の削除、非互換な動作変更
- **Minor (0.x.0)**: 後方互換性のある機能追加
  - 例: 新機能追加、設定項目の追加
- **Patch (0.0.x)**: 後方互換性のあるバグ修正
  - 例: バグ修正、パフォーマンス改善、リファクタリング

### 注意事項

- **マーケットプレイス非公開**: このフォークはVSCode Marketplaceには公開しない。GitHub Releasesからの配布のみ。
- **テスト必須**: リリース前に必ず`pnpm test`を実行し、全テストが通過することを確認する。
- **CHANGELOG**: 大きな変更がある場合は、GitHub Releaseの自動生成されるリリースノートに加えて、手動で補足情報を追加することを推奨。

## Markdown スタイルガイド

コードフェンスブロックの開始では必ず言語を明記すること。（特にプレーンテキスト）

```typescript
// 良い例
const example = "code";
```

```
// 悪い例（言語が指定されていない）
const example = "code";
```
